<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì „ì—¬í–‰ ê°€ì´ë“œ (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: "Pretendard Variable", Pretendard, -apple-system, sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #10b981; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ (ê³µí†µ) -->
    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
                    <div class="bg-emerald-600 text-white p-1.5 rounded-lg shadow-md"><i data-lucide="map-pin"></i></div>
                    <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-teal-500">ëŒ€ì „ì—¬í–‰ ê°€ì´ë“œ</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="hidden md:flex flex-col items-end text-[10px] text-gray-500">
                        <span>Today <b id="daily-count" class="text-emerald-600">0</b></span>
                        <span>Total <b id="total-count" class="text-gray-600">0</b></span>
                    </div>
                    <button id="auth-btn" onclick="toggleAuth()" class="flex items-center text-xs font-bold px-3 py-1.5 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <i data-lucide="user" class="w-3.5 h-3.5 mr-1"></i> ê´€ë¦¬ì
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ================= [1] í™ˆ í™”ë©´ (ë¦¬ìŠ¤íŠ¸) ================= -->
    <div id="home-view" class="fade-in">
        <!-- ê³µì§€ì‚¬í•­ -->
        <div class="bg-emerald-50 border-b border-emerald-100 h-10 flex items-center relative overflow-hidden">
            <div class="max-w-7xl mx-auto px-4 w-full flex items-center">
                <span class="bg-emerald-600 text-white text-[10px] px-2 py-0.5 rounded-full mr-3 font-bold shrink-0">NOTICE</span>
                <div class="flex-1 overflow-hidden relative h-6">
                    <div id="notice-track" class="absolute top-0 left-0 w-full transition-transform duration-500">
                        <div class="h-6 flex items-center text-sm text-emerald-800">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
                <button id="add-notice-btn" onclick="openNoticeModal()" class="hidden text-emerald-600 hover:text-emerald-800 ml-2"><i data-lucide="plus-circle" class="w-4 h-4"></i></button>
            </div>
        </div>

        <!-- íˆì–´ë¡œ ë°°ë„ˆ -->
        <div class="relative bg-emerald-900 overflow-hidden h-[280px] flex items-center justify-center text-center px-4">
            <div class="absolute inset-0 opacity-40">
                <img src="https://images.unsplash.com/photo-1627960682701-7b001a140228?auto=format&fit=crop&q=80&w=1600" class="w-full h-full object-cover animate-[pulse_15s_ease-in-out_infinite]">
            </div>
            <div class="absolute inset-0 bg-gradient-to-t from-emerald-900/90 via-emerald-900/20 to-transparent"></div>
            <div class="relative z-10 max-w-2xl">
                <h1 class="text-3xl md:text-5xl font-extrabold text-white mb-3 drop-shadow-lg">ê¿€ì¼ë„ì‹œ ëŒ€ì „!</h1>
                <p class="text-emerald-100 text-sm md:text-base mb-6 font-light">í˜„ì§€ì¸ì´ ì¶”ì²œí•˜ëŠ” ì° ë§›ì§‘ê³¼ íë§ ëª…ì†Œ ëª¨ìŒì§‘</p>
                <button id="write-btn" onclick="openWriteModal()" class="hidden mx-auto bg-white text-emerald-700 font-bold py-2.5 px-6 rounded-full shadow-lg hover:bg-emerald-50 transition-transform active:scale-95 flex items-center">
                    <i data-lucide="edit-3" class="w-4 h-4 mr-2"></i> ë‚´ ì—¬í–‰ê¸° ì“°ê¸°
                </button>
            </div>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <!-- í•„í„° & ì •ë ¬ -->
            <div class="sticky top-16 z-30 bg-gray-50/95 backdrop-blur py-2 mb-6 flex flex-col md:flex-row justify-between items-center gap-3 border-b border-gray-200 pb-4">
                <div class="flex bg-white p-1 rounded-full shadow-sm border border-gray-200 overflow-x-auto max-w-full scrollbar-hide">
                    <button onclick="filterDistrict('ì „ì²´')" class="cat-btn active px-4 py-1.5 rounded-full text-sm font-bold bg-emerald-600 text-white transition-colors whitespace-nowrap" data-val="ì „ì²´">ì „ì²´</button>
                    <button onclick="filterDistrict('ë™êµ¬')" class="cat-btn px-4 py-1.5 rounded-full text-sm font-medium text-gray-500 hover:bg-gray-100 transition-colors whitespace-nowrap" data-val="ë™êµ¬">ë™êµ¬</button>
                    <button onclick="filterDistrict('ì¤‘êµ¬')" class="cat-btn px-4 py-1.5 rounded-full text-sm font-medium text-gray-500 hover:bg-gray-100 transition-colors whitespace-nowrap" data-val="ì¤‘êµ¬">ì¤‘êµ¬</button>
                    <button onclick="filterDistrict('ì„œêµ¬')" class="cat-btn px-4 py-1.5 rounded-full text-sm font-medium text-gray-500 hover:bg-gray-100 transition-colors whitespace-nowrap" data-val="ì„œêµ¬">ì„œêµ¬</button>
                    <button onclick="filterDistrict('ìœ ì„±êµ¬')" class="cat-btn px-4 py-1.5 rounded-full text-sm font-medium text-gray-500 hover:bg-gray-100 transition-colors whitespace-nowrap" data-val="ìœ ì„±êµ¬">ìœ ì„±êµ¬</button>
                    <button onclick="filterDistrict('ëŒ€ë•êµ¬')" class="cat-btn px-4 py-1.5 rounded-full text-sm font-medium text-gray-500 hover:bg-gray-100 transition-colors whitespace-nowrap" data-val="ëŒ€ë•êµ¬">ëŒ€ë•êµ¬</button>
                </div>
                <select onchange="sortPlaces(this.value)" class="bg-white border border-gray-200 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="recent">âœ¨ ìµœì‹ ìˆœ</option>
                    <option value="rating">â­ í‰ì ìˆœ</option>
                    <option value="views">ğŸ”¥ ì¡°íšŒìˆœ</option>
                </select>
            </div>

            <!-- ë¡œë”©ë°” -->
            <div id="loader-area" class="flex justify-center py-20"><div class="loader"></div></div>
            
            <!-- ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ë“œ -->
            <div id="places-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 fade-in hidden">
                <!-- ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
            </div>
        </main>

        <!-- í‘¸í„° -->
        <footer class="bg-white border-t border-gray-200 py-10 mt-10">
            <div class="max-w-7xl mx-auto px-4 text-center text-gray-400 text-xs">
                <p class="mb-2">ëŒ€ì „ì—¬í–‰ ê°€ì´ë“œ &copy; 2025</p>
                <p>ë³¸ ì‚¬ì´íŠ¸ëŠ” í¬íŠ¸í´ë¦¬ì˜¤ìš©ìœ¼ë¡œ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            </div>
        </footer>
    </div>

    <!-- ================= [2] ìƒì„¸ í˜ì´ì§€ (Full View) ================= -->
    <div id="detail-view" class="hidden fixed inset-0 z-[60] bg-white overflow-y-auto animate-[slideUp_0.3s_ease-out]">
        <!-- ìƒì„¸ í—¤ë” -->
        <div class="sticky top-0 z-10 bg-white/90 backdrop-blur-md border-b border-gray-200 px-4 h-14 flex items-center justify-between">
            <button onclick="goHome()" class="flex items-center text-gray-600 hover:text-emerald-600 font-bold transition-colors">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i> ëª©ë¡ìœ¼ë¡œ
            </button>
            <span class="font-bold text-gray-800 text-sm truncate max-w-[200px]" id="header-title"></span>
            <div class="w-5"></div> <!-- ê³µê°„ë§ì¶¤ìš© -->
        </div>

        <div class="max-w-4xl mx-auto pb-20">
            <!-- ì´ë¯¸ì§€ ì˜ì—­ -->
            <div class="relative w-full bg-gray-100 group aspect-video md:aspect-[21/9]">
                <img id="detail-img" src="" class="w-full h-full object-contain">
                <button onclick="prevImage()" id="btn-prev" class="absolute left-4 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 hidden"><i data-lucide="chevron-left"></i></button>
                <button onclick="nextImage()" id="btn-next" class="absolute right-4 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 hidden"><i data-lucide="chevron-right"></i></button>
                <div id="img-indicator" class="absolute bottom-4 right-4 bg-black/60 text-white text-xs px-3 py-1 rounded-full font-medium">1 / 1</div>
            </div>

            <!-- ë‚´ìš© ì˜ì—­ -->
            <div class="px-5 py-8">
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6 border-b border-gray-100 pb-6">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span id="detail-district" class="bg-emerald-100 text-emerald-700 text-xs px-2.5 py-1 rounded font-bold"></span>
                            <div class="flex items-center text-yellow-500 text-sm font-bold"><i data-lucide="star" class="w-4 h-4 fill-yellow-500 mr-1"></i> <span id="detail-rating"></span></div>
                        </div>
                        <h1 id="detail-title" class="text-3xl font-extrabold text-gray-900 leading-tight"></h1>
                    </div>
                    <div class="text-gray-400 text-sm flex items-center">
                        <i data-lucide="eye" class="w-4 h-4 mr-1.5"></i> <span id="detail-views"></span>ëª…ì´ ë´¤ì–´ìš”
                    </div>
                </div>

                <div class="prose prose-emerald max-w-none">
                    <p id="detail-desc" class="text-gray-700 leading-8 whitespace-pre-line text-lg"></p>
                </div>

                <div class="mt-10">
                    <h3 class="font-bold text-gray-900 mb-3 flex items-center"><i data-lucide="hash" class="w-4 h-4 mr-1 text-emerald-500"></i> ê´€ë ¨ íƒœê·¸</h3>
                    <div id="detail-tags" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= [3] ê¸°ëŠ¥ ëª¨ë‹¬ë“¤ ================= -->

    <!-- ì±„íŒ… ìœ„ì ¯ -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end gap-3">
        <div id="chat-window" class="hidden bg-white w-[340px] h-[450px] rounded-2xl shadow-2xl border border-gray-200 flex flex-col overflow-hidden animate-[slideUp_0.3s_ease-out]">
            <div class="bg-emerald-600 p-4 text-white font-bold flex justify-between items-center shrink-0">
                <span class="flex items-center"><i data-lucide="message-circle" class="w-5 h-5 mr-2"></i> ì—¬í–‰ì ìˆ˜ë‹¤ë°©</span>
                <button onclick="toggleChat()" class="hover:bg-emerald-700 p-1 rounded"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50 text-sm"></div>
            <form onsubmit="sendChat(event)" class="p-3 border-t flex gap-2 bg-white shrink-0">
                <input id="chat-input" class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-500" placeholder="ë©”ì‹œì§€ ì…ë ¥..." required>
                <button type="submit" class="bg-emerald-600 text-white p-2 rounded-full hover:bg-emerald-700 shadow-md"><i data-lucide="send" class="w-4 h-4"></i></button>
            </form>
        </div>
        <button onclick="toggleChat()" class="bg-emerald-600 text-white p-3.5 rounded-full shadow-xl hover:bg-emerald-700 transition-transform hover:scale-105 flex items-center justify-center ring-4 ring-emerald-50">
            <i data-lucide="message-circle" class="w-7 h-7"></i>
        </button>
    </div>

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="login-modal" class="fixed inset-0 z-[100] hidden bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-xs p-8 shadow-2xl">
            <h3 class="font-bold text-xl mb-6 text-center text-gray-800">ê´€ë¦¬ì ì ‘ì†</h3>
            <input type="email" id="email" placeholder="ì•„ì´ë””(ì´ë©”ì¼)" class="w-full mb-3 p-3 border rounded-xl bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-emerald-500 transition-all">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full mb-6 p-3 border rounded-xl bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-emerald-500 transition-all">
            <button onclick="handleLogin()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 shadow-lg mb-3">ë¡œê·¸ì¸</button>
            <button onclick="closeModal('login-modal')" class="w-full py-2 text-gray-400 text-sm hover:text-gray-600">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ê³µì§€ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="notice-modal" class="fixed inset-0 z-[100] hidden bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">ê³µì§€ì‚¬í•­ ë“±ë¡</h3>
            <input id="notice-text" class="w-full mb-4 p-3 border rounded-lg" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button onclick="saveNotice()" class="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold">ë“±ë¡</button>
            <button onclick="closeModal('notice-modal')" class="w-full mt-2 py-2 text-gray-400 text-sm">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="write-modal" class="fixed inset-0 z-[100] hidden bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="write-modal-title" class="font-bold text-xl text-gray-900">ì—¬í–‰ê¸° ì‘ì„±</h3>
                <button onclick="closeModal('write-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button>
            </div>
            <input type="hidden" id="edit-id">
            <div class="space-y-5">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Title</label>
                    <input id="inp-name" class="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-emerald-500" placeholder="ì œëª© (ì˜ˆ: ì„±ì‹¬ë‹¹ ë¹µì§€ìˆœë¡€)">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">District</label>
                        <select id="inp-district" class="w-full p-3 border rounded-xl bg-gray-50 outline-none"><option>ë™êµ¬</option><option>ì¤‘êµ¬</option><option>ì„œêµ¬</option><option>ìœ ì„±êµ¬</option><option>ëŒ€ë•êµ¬</option></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Rating</label>
                        <input type="number" id="inp-rating" step="0.1" max="5" class="w-full p-3 border rounded-xl bg-gray-50 outline-none" placeholder="4.5">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Photos</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:bg-gray-50 transition-colors relative">
                        <input type="file" id="inp-files" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div id="upload-msg" class="text-sm text-gray-500"><i data-lucide="image-plus" class="inline mb-1"></i><br>í´ë¦­í•˜ì—¬ ì‚¬ì§„ ì¶”ê°€ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</div>
                        <div id="upload-status" class="text-sm text-blue-600 font-bold hidden">ì—…ë¡œë“œ ì¤‘...</div>
                    </div>
                    <div id="preview-area" class="flex gap-2 mt-3 overflow-x-auto h-20 scrollbar-hide py-1"></div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Content</label>
                    <textarea id="inp-desc" rows="6" class="w-full p-3 border rounded-xl bg-gray-50 outline-none resize-none" placeholder="ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."></textarea>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Tags</label>
                    <input id="inp-tags" class="w-full p-3 border rounded-xl bg-gray-50 outline-none" placeholder="#ë§›ì§‘ #íë§">
                </div>
                <button onclick="savePlace()" id="save-btn" class="w-full bg-emerald-600 text-white py-3.5 rounded-xl font-bold hover:bg-emerald-700 shadow-lg transform transition-transform active:scale-95">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ (ëª¨ë“ˆ) -->
    <script type="module">
        // ============================================================
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼ [í•„ìˆ˜] ì—¬ê¸°ì— ë³¸ì¸ í‚¤ë¥¼ ë®ì–´ì“°ì„¸ìš”! â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        const firebaseConfig = {
            apiKey: "AIzaSyC0SzZuWIl-E0L4VItN4nrHu-O1DaoZd88",
            authDomain: "project-5196212932199830884.firebaseapp.com",
            projectId: "project-5196212932199830884",
            storageBucket: "project-5196212932199830884.firebasestorage.app",
            messagingSenderId: "1:491579175390:web:e18c1334c7fd6a6c0ead4f",
            appId: "APP_ID"
        };
        // ============================================================

        // ì„¤ì •ê°’ ì²´í¬ (ê²½ê³ ì°½)
        if (firebaseConfig.projectId === "ë³¸ì¸_PROJECT_ID") {
            alert("âš ï¸ ì˜¤ë¥˜: Firebase ì„¤ì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!\n\nindex.html íŒŒì¼ì„ ì—´ê³  'firebaseConfig' ë¶€ë¶„ì„ ë³¸ì¸ì˜ Firebase í‚¤ê°’ìœ¼ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.\n(ë³€ê²½í•˜ì§€ ì•Šìœ¼ë©´ ì‚¬ì´íŠ¸ê°€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤)");
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, deleteDoc, increment, setDoc, getDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // 1. ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ì—ëŸ¬ ë°©ì§€)
        let app, auth, db, storage;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
        } catch(e) {
            console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
        }

        let currentUser = null;
        let allPlaces = [];
        let currentFilter = "ì „ì²´";
        let currentSort = "recent";

        // 2. í™”ë©´ ì „í™˜ (í˜ì´ì§€ ë°©ì‹)
        window.goHome = () => {
            document.getElementById("detail-view").classList.add("hidden");
            document.getElementById("home-view").classList.remove("hidden");
            window.scrollTo(0, 0);
        };

        window.openDetail = async (id) => {
            const place = allPlaces.find(p => p.id === id);
            if(!place) return;

            // ì¡°íšŒìˆ˜ ì¦ê°€ (ë°±ê·¸ë¼ìš´ë“œ)
            updateDoc(doc(db, "places", id), { views: increment(1) }).catch(e=>{});

            // ë°ì´í„° ì±„ìš°ê¸°
            currentDetailImages = (place.images && place.images.length > 0) ? place.images : [place.image || 'https://via.placeholder.com/800?text=No+Image'];
            currentImgIdx = 0;
            updateCarousel();

            document.getElementById("detail-title").innerText = place.name;
            document.getElementById("header-title").innerText = place.name;
            document.getElementById("detail-desc").innerText = place.description;
            document.getElementById("detail-district").innerText = place.district;
            document.getElementById("detail-rating").innerText = place.rating || 0;
            document.getElementById("detail-views").innerText = (place.views || 0) + 1;
            
            const tagsDiv = document.getElementById("detail-tags");
            tagsDiv.innerHTML = (place.tags || []).map(t => `<span class="bg-gray-100 text-gray-600 px-3 py-1.5 rounded-lg text-sm font-medium">#${t}</span>`).join('');

            // í™”ë©´ ì „í™˜
            document.getElementById("home-view").classList.add("hidden");
            document.getElementById("detail-view").classList.remove("hidden");
            window.scrollTo(0, 0);
        };

        // 3. ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë”
        let currentDetailImages = [];
        let currentImgIdx = 0;

        window.updateCarousel = () => {
            const img = document.getElementById("detail-img");
            const prev = document.getElementById("btn-prev");
            const next = document.getElementById("btn-next");
            const indic = document.getElementById("img-indicator");

            img.src = currentDetailImages[currentImgIdx];
            indic.innerText = `${currentImgIdx + 1} / ${currentDetailImages.length}`;

            if(currentDetailImages.length > 1) {
                indic.classList.remove("hidden");
                if(currentImgIdx === 0) prev.classList.add("hidden"); else prev.classList.remove("hidden");
                if(currentImgIdx === currentDetailImages.length - 1) next.classList.add("hidden"); else next.classList.remove("hidden");
            } else {
                indic.classList.add("hidden");
                prev.classList.add("hidden");
                next.classList.add("hidden");
            }
        };
        window.nextImage = () => { if(currentImgIdx < currentDetailImages.length-1) { currentImgIdx++; updateCarousel(); }};
        window.prevImage = () => { if(currentImgIdx > 0) { currentImgIdx--; updateCarousel(); }};

        // 4. ë°ì´í„° ë¡œë“œ & ë Œë”ë§
        if (db) {
            onSnapshot(collection(db, "places"), (snapshot) => {
                allPlaces = [];
                snapshot.forEach(doc => allPlaces.push({ id: doc.id, ...doc.data() }));
                document.getElementById("loader-area").classList.add("hidden");
                document.getElementById("places-grid").classList.remove("hidden");
                renderPlaces();
            }, (err) => {
                console.error(err);
                document.getElementById("loader-area").innerHTML = `<span class="text-red-500 text-sm">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨<br>ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.</span>`;
            });
        }

        window.renderPlaces = () => {
            const grid = document.getElementById("places-grid");
            grid.innerHTML = "";

            let filtered = currentFilter === "ì „ì²´" ? allPlaces : allPlaces.filter(p => p.district === currentFilter);
            
            filtered.sort((a, b) => {
                if(currentSort === 'rating') return (b.rating||0) - (a.rating||0);
                if(currentSort === 'views') return (b.views||0) - (a.views||0);
                return (b.createdAt||0) - (a.createdAt||0);
            });

            filtered.forEach(place => {
                const isAdmin = !!currentUser;
                const thumb = (place.images && place.images.length > 0) ? place.images[0] : (place.image || 'https://via.placeholder.com/400?text=No+Image');
                
                const card = document.createElement("div");
                card.className = "group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all border border-gray-100 overflow-hidden flex flex-col h-full cursor-pointer relative";
                // í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
                card.onclick = (e) => {
                    // ê´€ë¦¬ì ë²„íŠ¼ í´ë¦­ ì‹œ ìƒì„¸ì´ë™ ë°©ì§€
                    if(e.target.closest('.admin-btn')) return;
                    openDetail(place.id);
                };

                let adminHtml = "";
                if(isAdmin) {
                    adminHtml = `<div class="absolute top-2 right-2 z-20 flex gap-1">
                        <button onclick="editPlace('${place.id}')" class="admin-btn bg-white/90 p-2 rounded-full text-blue-600 hover:bg-blue-100 shadow-sm"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                        <button onclick="deletePlace('${place.id}')" class="admin-btn bg-white/90 p-2 rounded-full text-red-600 hover:bg-red-100 shadow-sm"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>`;
                }

                card.innerHTML = `
                    <div class="relative h-48 overflow-hidden bg-gray-100">
                        <img src="${thumb}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                        <div class="absolute top-3 left-3 bg-white/90 backdrop-blur px-2 py-1 rounded-md text-[10px] font-bold text-emerald-600 shadow-sm z-10">
                            ${place.district}
                        </div>
                        ${adminHtml}
                    </div>
                    <div class="p-5 flex flex-col flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-bold text-gray-800 group-hover:text-emerald-600 transition-colors line-clamp-1">${place.name}</h3>
                            <div class="flex items-center text-yellow-500 text-xs font-bold bg-yellow-50 px-1.5 py-0.5 rounded ml-2 shrink-0">
                                <i data-lucide="star" class="w-3 h-3 fill-yellow-500 mr-1"></i> ${place.rating || 0}
                            </div>
                        </div>
                        <p class="text-gray-500 text-sm mb-4 line-clamp-2 leading-relaxed">${place.description}</p>
                        <div class="mt-auto flex items-center justify-between">
                            <div class="flex gap-1 flex-wrap">
                                ${(place.tags || []).slice(0, 3).map(t => `<span class="bg-gray-100 text-gray-500 text-[10px] px-2 py-1 rounded-md">#${t}</span>`).join('')}
                            </div>
                            <div class="text-gray-400 text-xs flex items-center">
                                <i data-lucide="eye" class="w-3 h-3 mr-1"></i> ${place.views || 0}
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            lucide.createIcons();
        };

        window.filterDistrict = (d) => { currentFilter = d; updateFilterUI(); renderPlaces(); };
        window.sortPlaces = (s) => { currentSort = s; renderPlaces(); };
        function updateFilterUI() {
            document.querySelectorAll(".cat-btn").forEach(btn => {
                if(btn.dataset.val === currentFilter) {
                    btn.className = "cat-btn active px-4 py-1.5 rounded-full text-sm font-bold bg-emerald-600 text-white transition-colors whitespace-nowrap";
                } else {
                    btn.className = "cat-btn px-4 py-1.5 rounded-full text-sm font-medium text-gray-500 hover:bg-gray-100 transition-colors whitespace-nowrap";
                }
            });
        }

        // 5. ê¸°íƒ€ ê¸°ëŠ¥ (ë¡œê·¸ì¸, ê¸€ì“°ê¸° ë“±)
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                const authBtn = document.getElementById("auth-btn");
                const writeBtn = document.getElementById("write-btn");
                const noticeBtn = document.getElementById("add-notice-btn");
                if(user) {
                    authBtn.innerHTML = `<i data-lucide="log-out" class="w-3.5 h-3.5 mr-1"></i> ë¡œê·¸ì•„ì›ƒ`;
                    authBtn.onclick = async () => { if(confirm("ë¡œê·¸ì•„ì›ƒ?")) await signOut(auth); };
                    writeBtn.classList.remove("hidden");
                    noticeBtn.classList.remove("hidden");
                } else {
                    authBtn.innerHTML = `<i data-lucide="user" class="w-3.5 h-3.5 mr-1"></i> ê´€ë¦¬ì`;
                    authBtn.onclick = toggleAuth;
                    writeBtn.classList.add("hidden");
                    noticeBtn.classList.add("hidden");
                }
                renderPlaces();
            });
        }

        // 6. ì±„íŒ…, ê³µì§€, í†µê³„ ë“± ë‚˜ë¨¸ì§€ ê¸°ëŠ¥ (ì´ì „ê³¼ ë™ì¼)
        
        // ì±„íŒ… ë¡œë“œ
        let chatUnsub;
        window.toggleChat = () => {
            const w = document.getElementById("chat-window");
            w.classList.toggle("hidden");
            if(!w.classList.contains("hidden") && !chatUnsub && db) {
                const q = query(collection(db, "chat"), orderBy("createdAt", "asc"), limit(50));
                chatUnsub = onSnapshot(q, (snap) => {
                    const box = document.getElementById("chat-messages");
                    box.innerHTML = "";
                    snap.forEach(doc => {
                        const d = doc.data();
                        const isAdm = d.uid === 'admin';
                        const time = new Date(d.createdAt).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                        box.innerHTML += `<div class="flex flex-col ${isAdm?'items-start':'items-end'}"><div class="${isAdm?'bg-emerald-100 text-emerald-900':'bg-gray-100 text-gray-800'} px-3 py-1.5 rounded-lg text-sm max-w-[85%]">${d.text}</div><span class="text-[9px] text-gray-400 mt-0.5">${time}</span></div>`;
                    });
                    box.scrollTop = box.scrollHeight;
                });
            }
        };
        window.sendChat = async(e) => {
            e.preventDefault();
            const inp = document.getElementById("chat-input");
            if(inp.value.trim() && db) {
                await addDoc(collection(db, "chat"), { text: inp.value, createdAt: Date.now(), uid: currentUser?'admin':'anon' });
                inp.value = "";
            }
        };

        // í†µê³„
        const todayKey = new Date().toISOString().slice(0, 10);
        if (db) {
            onSnapshot(doc(db, "stats", "global"), (doc) => {
                if(doc.exists()) {
                    document.getElementById("total-count").innerText = (doc.data().total||0).toLocaleString();
                    document.getElementById("daily-count").innerText = (doc.data()[todayKey]||0).toLocaleString();
                }
            });
            // í†µê³„ ì¦ê°€ (ì„¸ì…˜ì²´í¬)
            if(!sessionStorage.getItem("visited")) {
                setDoc(doc(db, "stats", "global"), { total: increment(1), [todayKey]: increment(1) }, { merge: true });
                sessionStorage.setItem("visited", "true");
            }

            // ê³µì§€
            onSnapshot(query(collection(db, "notices"), orderBy("createdAt", "desc"), limit(5)), (snap) => {
                if(!snap.empty) {
                    const notices = [];
                    snap.forEach(d => notices.push(d.data().text));
                    const track = document.getElementById("notice-track");
                    track.innerHTML = notices.map(n => `<div class="h-6 flex items-center text-sm text-emerald-800 font-medium truncate"><i data-lucide="bell" class="w-3 h-3 mr-2"></i> ${n}</div>`).join('');
                    let i = 0;
                    if(notices.length>1) setInterval(() => { i=(i+1)%notices.length; track.style.transform=`translateY(-${i*24}px)`; }, 4000);
                }
            });
        }

        // ê¸€ì“°ê¸° ê´€ë ¨ í•¨ìˆ˜ë“¤
        let upImgs = [];
        window.openWriteModal = () => {
            upImgs = [];
            document.getElementById("preview-area").innerHTML = "";
            document.getElementById("write-modal").classList.remove("hidden");
        };
        document.getElementById("inp-files").addEventListener("change", async(e) => {
            const files = Array.from(e.target.files);
            const status = document.getElementById("upload-status");
            const msg = document.getElementById("upload-msg");
            if(!files.length) return;
            
            status.classList.remove("hidden");
            msg.classList.add("hidden");
            status.innerText = `${files.length}ì¥ ì—…ë¡œë“œ ì¤‘...`;

            try {
                if (storage) {
                    const urls = await Promise.all(files.map(f => uploadBytesResumable(ref(storage, 'img/'+Date.now()+'_'+f.name), f).then(s => getDownloadURL(s.ref))));
                    upImgs = [...upImgs, ...urls];
                    const preview = document.getElementById("preview-area");
                    urls.forEach(u => preview.innerHTML += `<img src="${u}" class="h-16 w-16 object-cover rounded-lg border border-gray-200 shrink-0">`);
                    status.innerText = "ì™„ë£Œ!";
                }
            } catch(e) { alert("ì—…ë¡œë“œ ì‹¤íŒ¨"); }
        });
        window.savePlace = async() => {
            const id = document.getElementById("edit-id").value;
            const data = {
                name: document.getElementById("inp-name").value,
                district: document.getElementById("inp-district").value,
                rating: parseFloat(document.getElementById("inp-rating").value)||0,
                description: document.getElementById("inp-desc").value,
                tags: document.getElementById("inp-tags").value.split(",").filter(t=>t.trim()),
                images: upImgs,
                image: upImgs[0]||"",
                createdAt: Date.now()
            };
            if(!data.name) return alert("ì œëª© ì…ë ¥ í•„ìˆ˜");
            const btn = document.getElementById("save-btn");
            btn.disabled=true; btn.innerText="ì €ì¥ ì¤‘...";
            try {
                if (db) {
                    if(id) await updateDoc(doc(db, "places", id), data);
                    else { data.views=0; await addDoc(collection(db, "places"), data); }
                    closeModal("write-modal");
                }
            } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
            btn.disabled=false; btn.innerText="ì €ì¥í•˜ê¸°";
        };
        window.editPlace = (id) => {
            const p = allPlaces.find(x=>x.id===id);
            if(!p) return;
            openWriteModal();
            document.getElementById("edit-id").value = p.id;
            document.getElementById("inp-name").value = p.name;
            document.getElementById("inp-district").value = p.district;
            document.getElementById("inp-rating").value = p.rating;
            document.getElementById("inp-desc").value = p.description;
            document.getElementById("inp-tags").value = p.tags.join(",");
            upImgs = p.images||[p.image];
            const preview = document.getElementById("preview-area");
            upImgs.forEach(u => { if(u) preview.innerHTML += `<img src="${u}" class="h-16 w-16 object-cover rounded-lg border border-gray-200 shrink-0">`; });
        };
        window.deletePlace = async(id) => { if(confirm("ì‚­ì œ?") && db) await deleteDoc(doc(db, "places", id)); };
        window.saveNotice = async() => {
            const t = document.getElementById("notice-text").value;
            if(t && db) { await addDoc(collection(db, "notices"), {text:t, createdAt:Date.now()}); closeModal("notice-modal"); alert("ë“±ë¡ë¨"); }
        };

        // ìœ í‹¸
        window.toggleAuth = () => document.getElementById("login-modal").classList.remove("hidden");
        window.openNoticeModal = () => document.getElementById("notice-modal").classList.remove("hidden");
        window.closeModal = (id) => document.getElementById(id).classList.add("hidden");
        window.handleLogin = async() => {
            try { if (auth) await signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value); closeModal("login-modal"); }
            catch(e) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨"); }
        };
        window.lucide = lucide;

    </script>
</body>
</html>
