<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì „ì—¬í–‰ ê°€ì´ë“œ (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: "Pretendard Variable", Pretendard, -apple-system, sans-serif; }
        .page-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #10b981; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 4px; }
        .nav-item.active { background-color: #ecfdf5; color: #059669; font-weight: 700; border-right: 3px solid #059669; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- ì„¤ì • ì˜¤ë¥˜ ì˜¤ë²„ë ˆì´ -->
    <div id="config-error-overlay" class="fixed inset-0 z-[999] bg-black/80 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-2xl max-w-md text-center shadow-2xl">
            <div class="text-red-500 mb-4 flex justify-center"><i data-lucide="alert-triangle" class="w-12 h-12"></i></div>
            <h2 class="text-xl font-bold mb-2">ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
            <p class="text-gray-600 mb-6 text-sm">
                Firebase ì„¤ì •(API Key)ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>
                index.html íŒŒì¼ì˜ <code>firebaseConfig</code> ë¶€ë¶„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
            </p>
            <button onclick="location.reload()" class="bg-gray-900 text-white px-6 py-2 rounded-lg hover:bg-gray-800">ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </div>

    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 hover:bg-gray-100 rounded-lg text-gray-600">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
                        <div class="bg-emerald-600 text-white p-1.5 rounded-lg shadow-md"><i data-lucide="map-pin"></i></div>
                        <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-teal-500">ëŒ€ì „ ì—¬í–‰ ê°€ì´ë“œ</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button id="auth-btn" onclick="openLoginModal()" class="flex items-center text-xs font-bold px-3 py-1.5 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                        <i data-lucide="log-in" class="w-3.5 h-3.5 mr-1"></i> ë¡œê·¸ì¸
                    </button>
                    <img id="user-profile-img" class="w-8 h-8 rounded-full border border-gray-200 hidden" src="" alt="Profile">
                </div>
            </div>
        </div>
    </nav>

    <!-- ================= [1] ë©”ì¸ ë ˆì´ì•„ì›ƒ ================= -->
    <div id="main-layout" class="max-w-7xl mx-auto px-4 py-8 page-enter relative">
        <div class="flex flex-col lg:flex-row gap-8 items-start">
            
            <!-- [ì¢Œì¸¡ ì‚¬ì´ë“œë°”] -->
            <div id="mobile-sidebar-backdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden opacity-0 transition-opacity duration-300"></div>
            
            <aside id="sidebar" class="fixed top-0 left-0 bottom-0 w-72 bg-white z-50 transform -translate-x-full lg:translate-x-0 lg:static lg:w-72 shrink-0 space-y-6 lg:block transition-transform duration-300 overflow-y-auto lg:overflow-visible shadow-2xl lg:shadow-none p-4 lg:p-0">
                <div class="flex justify-between items-center lg:hidden mb-4 px-2">
                    <span class="font-bold text-lg text-gray-800">ë©”ë‰´</span>
                    <button onclick="toggleSidebar()" class="p-1 hover:bg-gray-100 rounded"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>

                <!-- 1. ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-4 bg-gray-50 border-b border-gray-100 font-bold text-gray-700 flex items-center hidden lg:flex">
                        <i data-lucide="menu" class="w-4 h-4 mr-2"></i> ë©”ë‰´
                    </div>
                    <nav class="flex flex-col text-sm">
                        <a onclick="menuClick('')" class="nav-item cursor-pointer px-5 py-3 hover:bg-gray-50 transition-colors flex items-center text-gray-600">
                            <i data-lucide="home" class="w-4 h-4 mr-3"></i> í™ˆ (ì—¬í–‰ì§€ ëª©ë¡)
                        </a>
                        <a onclick="menuClick('#board/notice')" class="nav-item cursor-pointer px-5 py-3 hover:bg-gray-50 transition-colors flex items-center text-gray-600">
                            <i data-lucide="megaphone" class="w-4 h-4 mr-3"></i> ê³µì§€ì‚¬í•­
                        </a>
                        <a onclick="menuClick('#board/tip')" class="nav-item cursor-pointer px-5 py-3 hover:bg-gray-50 transition-colors flex items-center text-gray-600">
                            <i data-lucide="lightbulb" class="w-4 h-4 mr-3"></i> ëŒ€ì „ ì—¬í–‰ ê¿€íŒ
                        </a>
                        <a onclick="menuClick('#board/event')" class="nav-item cursor-pointer px-5 py-3 hover:bg-gray-50 transition-colors flex items-center text-gray-600">
                            <i data-lucide="calendar" class="w-4 h-4 mr-3"></i> ì¶•ì œ & ì´ë²¤íŠ¸
                        </a>
                        <div class="h-px bg-gray-100 my-1"></div>
                        <a onclick="menuClick('#freeboard')" class="nav-item cursor-pointer px-5 py-3 hover:bg-gray-50 transition-colors flex items-center text-emerald-600 font-bold">
                            <i data-lucide="message-square" class="w-4 h-4 mr-3"></i> ììœ ê²Œì‹œíŒ
                        </a>
                    </nav>
                </div>

                <!-- 2. ë°©ë¬¸ì í˜„í™© -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center"><i data-lucide="bar-chart-3" class="w-4 h-4 mr-2 text-emerald-600"></i> ë°©ë¬¸ì í†µê³„</h3>
                    <div class="flex justify-between items-center text-sm mb-2">
                        <span class="text-gray-500">ì˜¤ëŠ˜ (KST)</span>
                        <span id="daily-count" class="font-bold text-emerald-600">0</span>
                    </div>
                    <div class="w-full bg-gray-100 h-1.5 rounded-full mb-4 overflow-hidden">
                        <div class="bg-emerald-500 h-1.5 rounded-full animate-[width_1s_ease-out]" style="width: 60%"></div>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-500">ëˆ„ì </span>
                        <span id="total-count" class="font-bold text-gray-700">0</span>
                    </div>
                </div>

                <!-- 3. ì‹¤ì‹œê°„ ì±„íŒ…ë°© (PCìš©) -->
                <div class="hidden lg:flex flex-col bg-white rounded-2xl shadow-sm border border-gray-100 h-[350px] overflow-hidden sticky top-24">
                    <div class="bg-emerald-600 p-3 text-white font-bold flex justify-between items-center shrink-0">
                        <span class="flex items-center text-sm"><i data-lucide="message-circle" class="w-4 h-4 mr-2"></i> ì‹¤ì‹œê°„ í†¡</span>
                        <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded-full flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span> ON</span>
                    </div>
                    <div id="desktop-chat-messages" class="flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50 text-sm chat-scroll">
                        <div class="text-center text-xs text-gray-400 py-10">ë¡œë”© ì¤‘...</div>
                    </div>
                    <form onsubmit="sendChat(event, 'desktop')" class="p-2 border-t bg-white shrink-0">
                        <div class="flex gap-1">
                            <input id="desktop-chat-input" class="flex-1 bg-gray-100 rounded-lg px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-emerald-500" placeholder="ë©”ì‹œì§€ ì…ë ¥..." required>
                            <button type="submit" class="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700 transition-colors"><i data-lucide="send" class="w-3 h-3"></i></button>
                        </div>
                    </form>
                </div>
            </aside>

            <!-- [ìš°ì¸¡ ì»¨í…ì¸  ì˜ì—­] -->
            <section class="flex-1 w-full order-1 lg:order-2 min-h-[500px]">
                
                <!-- (A) í™ˆ ë·°: ì—¬í–‰ì§€ ëª©ë¡ -->
                <div id="home-view">
                    <!-- íˆì–´ë¡œ -->
                    <div class="relative bg-emerald-900 rounded-3xl overflow-hidden h-[240px] mb-8 shadow-lg group">
                        <div class="absolute inset-0 opacity-60">
                            <img id="hero-bg-img" src="https://images.unsplash.com/photo-1627960682701-7b001a140228?auto=format&fit=crop&q=80&w=1600" class="w-full h-full object-cover transition-transform duration-[20s] group-hover:scale-110">
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-r from-black/80 via-black/30 to-transparent"></div>
                        <div class="relative z-10 h-full flex flex-col justify-center px-8 md:px-12 items-start text-left">
                            <div class="bg-white/20 backdrop-blur-sm text-white text-[10px] font-bold px-2 py-0.5 rounded-md mb-3 border border-white/30">DAEJEON TRAVEL</div>
                            <h1 id="hero-main-text" class="text-3xl md:text-4xl font-extrabold text-white mb-2 leading-tight">ë…¸ì¼ë„ì‹œ íƒˆì¶œ!<br><span class="text-emerald-300">ëŒ€ì „ í•«í”Œ ê°€ì´ë“œ</span></h1>
                            <p id="hero-sub-text" class="text-emerald-100 text-sm font-light mb-6">í˜„ì§€ì¸ì´ ì§ì ‘ ì¶”ì²œí•˜ëŠ” ë§›ì§‘ & íë§ ìŠ¤íŒŸ</p>
                            <div class="flex gap-2">
                                <button id="write-btn" onclick="openWriteModal()" class="hidden bg-emerald-600 text-white text-sm font-bold py-2.5 px-5 rounded-full shadow-lg hover:bg-emerald-700 transition-all active:scale-95 flex items-center">
                                    <i data-lucide="edit-3" class="w-4 h-4 mr-2"></i> ì—¬í–‰ì§€ ë“±ë¡
                                </button>
                                <button id="edit-hero-btn" onclick="openHeroEditModal()" class="hidden bg-black/50 backdrop-blur text-white text-xs px-3 py-2 rounded-full hover:bg-black/70 flex items-center border border-white/20">
                                    <i data-lucide="settings" class="w-3.5 h-3.5 mr-1.5"></i> ë°°ê²½ í¸ì§‘
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- í•„í„° -->
                    <div class="bg-white p-2 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-col sm:flex-row justify-between items-center gap-3 sticky top-16 z-30">
                        <div class="flex gap-1 overflow-x-auto max-w-full scrollbar-hide w-full sm:w-auto pb-1 sm:pb-0">
                            <button onclick="filterDistrict('ì „ì²´')" class="cat-btn active px-3 py-1.5 rounded-lg text-sm font-bold bg-emerald-100 text-emerald-700 transition-colors whitespace-nowrap" data-val="ì „ì²´">ì „ì²´</button>
                            <button onclick="filterDistrict('ë™êµ¬')" class="cat-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 transition-colors whitespace-nowrap" data-val="ë™êµ¬">ë™êµ¬</button>
                            <button onclick="filterDistrict('ì¤‘êµ¬')" class="cat-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 transition-colors whitespace-nowrap" data-val="ì¤‘êµ¬">ì¤‘êµ¬</button>
                            <button onclick="filterDistrict('ì„œêµ¬')" class="cat-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 transition-colors whitespace-nowrap" data-val="ì„œêµ¬">ì„œêµ¬</button>
                            <button onclick="filterDistrict('ìœ ì„±êµ¬')" class="cat-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 transition-colors whitespace-nowrap" data-val="ìœ ì„±êµ¬">ìœ ì„±êµ¬</button>
                            <button onclick="filterDistrict('ëŒ€ë•êµ¬')" class="cat-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 transition-colors whitespace-nowrap" data-val="ëŒ€ë•êµ¬">ëŒ€ë•êµ¬</button>
                        </div>
                        <select onchange="sortPlaces(this.value)" class="bg-gray-50 border-0 rounded-lg px-3 py-1.5 text-sm font-medium text-gray-600 focus:ring-2 focus:ring-emerald-500 w-full sm:w-auto">
                            <option value="recent">âœ¨ ìµœì‹ ìˆœ</option>
                            <option value="rating">â­ í‰ì ìˆœ</option>
                            <option value="views">ğŸ”¥ ì¡°íšŒìˆœ</option>
                        </select>
                    </div>

                    <div id="loader-area" class="flex justify-center py-20"><div class="loader"></div></div>
                    <div id="places-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-6 fade-in hidden"></div>
                </div>

                <!-- (B) ê²Œì‹œíŒ ë·° (ê³µì§€/íŒ/ì´ë²¤íŠ¸) -->
                <div id="board-view" class="hidden fade-in">
                    <div class="flex justify-between items-end mb-6 border-b border-gray-200 pb-4">
                        <div>
                            <h2 id="board-title" class="text-2xl font-bold text-gray-800">ê²Œì‹œíŒ</h2>
                            <p id="board-desc" class="text-sm text-gray-500 mt-1">ìœ ìš©í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                        </div>
                        <button id="board-write-btn" onclick="openNoticeModal()" class="hidden bg-emerald-600 text-white text-sm px-4 py-2 rounded-lg font-bold hover:bg-emerald-700 flex items-center transition-colors">
                            <i data-lucide="pen-tool" class="w-4 h-4 mr-2"></i> ê¸€ì“°ê¸°
                        </button>
                    </div>
                    <div id="board-list" class="space-y-4"></div>
                </div>

                <!-- (C) ììœ ê²Œì‹œíŒ -->
                <div id="free-board-view" class="hidden fade-in">
                    <div class="flex justify-between items-end mb-6 border-b border-gray-200 pb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">ğŸ’¬ ììœ ê²Œì‹œíŒ</h2>
                            <p class="text-sm text-gray-500 mt-1">ì—¬í–‰ìë“¤ê³¼ ììœ ë¡­ê²Œ ì†Œí†µí•˜ì„¸ìš”.</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <select onchange="sortFreeBoard(this.value)" class="text-sm border rounded-lg px-2 py-1.5 bg-white">
                                <option value="desc">ìµœì‹ ìˆœ</option>
                                <option value="asc">ì˜¤ë˜ëœìˆœ</option>
                            </select>
                            <button onclick="openFreeWriteModal()" class="bg-emerald-600 text-white text-sm px-4 py-2 rounded-lg font-bold hover:bg-emerald-700 flex items-center transition-colors">
                                <i data-lucide="pen-tool" class="w-4 h-4 mr-2"></i> ê¸€ì“°ê¸°
                            </button>
                        </div>
                    </div>
                    <div id="free-board-list" class="space-y-4"></div>
                </div>

                <!-- (D) ìƒì„¸ ë·° -->
                <div id="detail-view" class="hidden fade-in">
                    <div class="mb-4">
                        <button onclick="history.back()" class="flex items-center text-gray-500 hover:text-emerald-600 font-bold transition-colors">
                            <i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i> ë’¤ë¡œê°€ê¸°
                        </button>
                    </div>
                    <div class="bg-white rounded-3xl overflow-hidden shadow-sm border border-gray-100">
                        <div class="relative w-full bg-gray-100 group aspect-video">
                            <div id="detail-img-loader" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-20 hidden"><div class="loader"></div></div>
                            <img id="detail-img" src="" class="w-full h-full object-cover transition-opacity duration-300 opacity-0">
                            <button onclick="prevImage()" id="btn-prev" class="absolute left-4 top-1/2 -translate-y-1/2 bg-black/30 backdrop-blur text-white p-2 rounded-full hover:bg-black/50 hidden z-20"><i data-lucide="chevron-left"></i></button>
                            <button onclick="nextImage()" id="btn-next" class="absolute right-4 top-1/2 -translate-y-1/2 bg-black/30 backdrop-blur text-white p-2 rounded-full hover:bg-black/50 hidden z-20"><i data-lucide="chevron-right"></i></button>
                            <div id="img-indicator" class="absolute bottom-4 right-4 bg-black/50 backdrop-blur text-white text-xs px-3 py-1 rounded-full font-medium z-20">1 / 1</div>
                        </div>
                        <div class="p-6 md:p-10">
                            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8 border-b border-gray-100 pb-6">
                                <div>
                                    <div class="flex items-center gap-2 mb-3">
                                        <span id="detail-district" class="bg-emerald-100 text-emerald-700 text-xs px-2.5 py-1 rounded font-bold"></span>
                                        <div class="flex items-center text-yellow-500 text-sm font-bold"><i data-lucide="star" class="w-4 h-4 fill-yellow-500 mr-1"></i> <span id="detail-rating"></span></div>
                                    </div>
                                    <h1 id="detail-title" class="text-3xl md:text-4xl font-extrabold text-gray-900 leading-tight"></h1>
                                </div>
                                <div class="text-gray-400 text-sm flex items-center shrink-0">
                                    <i data-lucide="eye" class="w-4 h-4 mr-1.5"></i> <span id="detail-views"></span>íšŒ ì¡°íšŒ
                                </div>
                            </div>
                            <div class="prose prose-emerald max-w-none mb-10">
                                <p id="detail-desc" class="text-gray-700 leading-8 whitespace-pre-line text-lg"></p>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-900 mb-3 flex items-center text-sm uppercase tracking-wide text-gray-400">Tags</h3>
                                <div id="detail-tags" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <footer class="mt-12 text-center text-gray-400 text-xs py-6 border-t border-gray-100">
                    <p>ëŒ€ì „ì—¬í–‰ ê°€ì´ë“œ &copy; 2025</p>
                </footer>
            </section>
        </div>
    </div>

    <!-- ================= [ëª¨ë‹¬ë“¤] ================= -->

    <!-- ë¡œê·¸ì¸ -->
    <div id="login-modal" class="fixed inset-0 z-[100] hidden bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-8 shadow-2xl relative">
            <button onclick="closeModal('login-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button>
            <h3 class="font-bold text-xl mb-6 text-center text-gray-800">ë¡œê·¸ì¸</h3>
            <button onclick="loginWithGoogle()" class="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-50 flex items-center justify-center mb-4 transition-colors">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>Googleë¡œ ê³„ì†í•˜ê¸°
            </button>
            <div class="relative my-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">ë˜ëŠ” ê´€ë¦¬ì ë¡œê·¸ì¸</span></div></div>
            <input type="email" id="email" placeholder="ê´€ë¦¬ì ì´ë©”ì¼" class="w-full mb-3 p-3 border rounded-xl bg-gray-50 outline-none text-sm">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full mb-4 p-3 border rounded-xl bg-gray-50 outline-none text-sm">
            <button onclick="handleAdminLogin()" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold hover:bg-gray-900 text-sm">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
        </div>
    </div>

    <!-- ëª¨ë°”ì¼ ì±„íŒ… (ë²„íŠ¼ + ì°½) -->
    <div class="lg:hidden fixed bottom-6 right-6 z-50 flex flex-col items-end gap-3">
        <div id="mobile-chat-window" class="hidden bg-white w-[300px] h-[400px] rounded-2xl shadow-2xl border border-gray-200 flex flex-col overflow-hidden animate-[slideUp_0.3s_ease-out]">
            <div class="bg-emerald-600 p-3 text-white font-bold flex justify-between items-center shrink-0">
                <span class="flex items-center text-sm"><i data-lucide="message-circle" class="w-4 h-4 mr-2"></i> ì‹¤ì‹œê°„ í†¡</span>
                <button onclick="toggleMobileChat()" class="hover:bg-emerald-700 p-1 rounded"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="mobile-chat-messages" class="flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50 text-sm chat-scroll"></div>
            <form onsubmit="sendChat(event, 'mobile')" class="p-2 border-t bg-white shrink-0">
                <div class="flex gap-1">
                    <input id="mobile-chat-input" class="flex-1 bg-gray-100 rounded-full px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-emerald-500" placeholder="ë©”ì‹œì§€ ì…ë ¥..." required>
                    <button type="submit" class="bg-emerald-600 text-white p-2 rounded-full hover:bg-emerald-700 shadow-md"><i data-lucide="send" class="w-3 h-3"></i></button>
                </div>
            </form>
        </div>
        <button onclick="toggleMobileChat()" class="bg-emerald-600 text-white p-3.5 rounded-full shadow-xl hover:bg-emerald-700 transition-transform hover:scale-105 flex items-center justify-center ring-4 ring-emerald-50">
            <i data-lucide="message-circle" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- ê³µì§€/ê²Œì‹œê¸€ ë“±ë¡ -->
    <div id="notice-modal" class="fixed inset-0 z-[100] hidden bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg" id="notice-modal-title">ê²Œì‹œê¸€ ë“±ë¡</h3><button onclick="closeModal('notice-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button></div>
            <input type="hidden" id="notice-edit-id">
            <select id="notice-cat" class="w-full mb-3 p-3 border rounded-lg bg-gray-50 outline-none">
                <option value="notice">ğŸ“¢ ê³µì§€ì‚¬í•­</option>
                <option value="tip">ğŸ¯ ê¿€íŒ</option>
                <option value="festival">ğŸ† ì¶•ì œ</option> 
                <option value="event">ğŸ ì´ë²¤íŠ¸</option>
            </select>
            <input id="notice-title" class="w-full mb-3 p-3 border rounded-lg bg-gray-50 outline-none" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            <textarea id="notice-text" class="w-full mb-4 p-3 border rounded-lg h-32 resize-none outline-none" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <button onclick="saveNotice()" id="notice-save-btn" class="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold">ë“±ë¡</button>
        </div>
    </div>

    <!-- ê³µì§€ ìƒì„¸ -->
    <div id="notice-detail-modal" class="fixed inset-0 z-[100] hidden bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl relative">
            <div class="flex justify-between items-start mb-4 pb-2 border-b">
                <div><span class="text-xs text-emerald-600 font-bold mb-1 block" id="notice-detail-cat"></span><h3 class="font-bold text-xl text-gray-800 leading-tight" id="notice-detail-title"></h3></div>
                <button onclick="closeModal('notice-detail-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button>
            </div>
            <div id="notice-detail-content" class="text-gray-700 text-base leading-relaxed whitespace-pre-line min-h-[100px]"></div>
            <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-100">
                <span class="text-xs text-gray-400" id="notice-detail-date"></span>
                <div id="notice-admin-btns" class="hidden gap-2"><button id="btn-notice-edit" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 font-bold">ìˆ˜ì •</button><button id="btn-notice-delete" class="text-xs bg-red-50 text-red-600 px-2 py-1 rounded hover:bg-red-100 font-bold">ì‚­ì œ</button></div>
            </div>
        </div>
    </div>

    <!-- ììœ ê²Œì‹œíŒ ê¸€ì“°ê¸° ë“± ê¸°íƒ€ ëª¨ë‹¬ ìƒëµ (ìœ„ì™€ ë™ì¼) -->
    <div id="free-write-modal" class="fixed inset-0 z-[100] hidden bg-black/60 flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">ììœ ê²Œì‹œíŒ ê¸€ì“°ê¸°</h3><button onclick="closeModal('free-write-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button></div><input id="free-title" class="w-full mb-3 p-3 border rounded-lg bg-gray-50 outline-none" placeholder="ì œëª©"><textarea id="free-text" class="w-full mb-4 p-3 border rounded-lg h-32 resize-none outline-none" placeholder="ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."></textarea><button onclick="saveFreePost()" class="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold">ë“±ë¡í•˜ê¸°</button></div></div>
    <div id="free-detail-modal" class="fixed inset-0 z-[100] hidden bg-black/60 flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-md shadow-2xl relative flex flex-col max-h-[90vh]"><div class="p-6 pb-0 flex-none"><div class="flex justify-between items-start mb-4 pb-2 border-b"><div class="flex items-center gap-3"><img id="free-detail-avatar" src="" class="w-10 h-10 rounded-full border"><div><div class="text-xs text-gray-500" id="free-detail-author"></div><h3 class="font-bold text-lg text-gray-800 leading-tight" id="free-detail-title"></h3></div></div><button onclick="closeModal('free-detail-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button></div><div id="free-detail-content" class="text-gray-700 text-base leading-relaxed whitespace-pre-line min-h-[80px]"></div><div class="flex justify-between items-center mt-4 pt-2 border-t border-gray-100"><span class="text-xs text-gray-400" id="free-detail-date"></span><div id="free-owner-btns" class="hidden gap-2"><button id="btn-free-delete" class="text-xs bg-red-50 text-red-600 px-2 py-1 rounded hover:bg-red-100 font-bold">ì‚­ì œ</button></div></div></div><div class="flex-1 bg-gray-50 p-4 overflow-y-auto border-t mt-4 rounded-b-2xl"><h4 class="text-sm font-bold text-gray-700 mb-3">ëŒ“ê¸€ <span id="comment-count" class="text-emerald-600">0</span></h4><div id="comment-list" class="space-y-3 mb-4"></div><form onsubmit="saveComment(event)" class="flex gap-2"><input id="comment-input" class="flex-1 text-sm p-2 border rounded-lg outline-none focus:ring-1 focus:ring-emerald-500" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required><button type="submit" class="bg-emerald-600 text-white text-sm px-3 rounded-lg font-bold">ë“±ë¡</button></form></div></div></div>
    <div id="hero-edit-modal" class="fixed inset-0 z-[100] hidden bg-black/60 flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl"><h3 class="font-bold text-lg mb-4">ë©”ì¸ í™”ë©´ ì„¤ì •</h3><div class="space-y-3"><input id="edit-hero-title" class="w-full p-2 border rounded bg-gray-50" placeholder="ë©”ì¸ ë¬¸êµ¬"><input id="edit-hero-sub" class="w-full p-2 border rounded bg-gray-50" placeholder="ì„œë¸Œ ë¬¸êµ¬"><input id="edit-hero-img" class="w-full p-2 border rounded bg-gray-50" placeholder="ë°°ê²½ ì´ë¯¸ì§€ URL"><button onclick="saveHeroConfig()" class="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold mt-2">ì €ì¥í•˜ê¸°</button><button onclick="closeModal('hero-edit-modal')" class="w-full py-2 text-gray-400 text-sm">ì·¨ì†Œ</button></div></div></div>
    <div id="write-modal" class="fixed inset-0 z-[100] hidden bg-black/60 flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl max-h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-6"><h3 id="write-modal-title" class="font-bold text-xl text-gray-900">ì—¬í–‰ì§€ ì‘ì„±</h3><button onclick="closeModal('write-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button></div><input type="hidden" id="edit-id"><div class="space-y-5"><input id="inp-name" class="w-full p-3 border rounded-xl bg-gray-50 outline-none" placeholder="ì œëª©"><div class="grid grid-cols-2 gap-4"><select id="inp-district" class="w-full p-3 border rounded-xl bg-gray-50 outline-none"><option>ë™êµ¬</option><option>ì¤‘êµ¬</option><option>ì„œêµ¬</option><option>ìœ ì„±êµ¬</option><option>ëŒ€ë•êµ¬</option></select><input type="number" id="inp-rating" step="0.1" max="5" class="w-full p-3 border rounded-xl bg-gray-50 outline-none" placeholder="í‰ì  (4.5)"></div><div><div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center relative"><input type="file" id="inp-files" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"><div id="upload-msg" class="text-sm text-gray-500">ì‚¬ì§„ ì¶”ê°€ (í´ë¦­)</div><div id="upload-status" class="text-sm text-blue-600 hidden">ì—…ë¡œë“œ ì¤‘...</div></div><div id="preview-area" class="flex gap-2 mt-3 overflow-x-auto h-20 scrollbar-hide"></div></div><textarea id="inp-desc" rows="6" class="w-full p-3 border rounded-xl bg-gray-50 outline-none resize-none" placeholder="ë‚´ìš©"></textarea><input id="inp-tags" class="w-full p-3 border rounded-xl bg-gray-50 outline-none" placeholder="íƒœê·¸ (#ë§›ì§‘)"><button onclick="savePlace()" id="save-btn" class="w-full bg-emerald-600 text-white py-3.5 rounded-xl font-bold">ì €ì¥í•˜ê¸°</button></div></div></div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        // ============================================================
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼ [í•„ìˆ˜] ë³¸ì¸ í‚¤ë¥¼ ë®ì–´ì“°ì„¸ìš”! â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        const firebaseConfig = {
 apiKey: "AIzaSyC0SzZuWIl-E0L4VItN4nrHu-O1DaoZd88",
  authDomain: "project-5196212932199830884.firebaseapp.com",
  projectId: "project-5196212932199830884",
  storageBucket: "project-5196212932199830884.firebasestorage.app",
  messagingSenderId: "491579175390",
  appId: "1:491579175390:web:e18c1334c7fd6a6c0ead4f",
        };
        // ============================================================

        if (firebaseConfig.projectId === "ë³¸ì¸_PROJECT_ID") {
            document.getElementById("config-error-overlay").classList.remove("hidden");
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, doc, deleteDoc, increment, setDoc, getDoc, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        let app, auth, db, storage;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
        } catch(e) { console.error(e); }

        let currentUser = null;
        let isAdmin = false;
        let allPlaces = [];
        let allNotices = [];
        let currentFilter = "ì „ì²´";
        let currentSort = "recent";
        let freeBoardSort = "desc";
        let currentFreePostId = null;

        // GLOBAL EXPORT to fix ReferenceError
        window.menuClick = (hash) => location.hash = hash;
        window.toggleSidebar = () => {
            const sidebar = document.getElementById("sidebar");
            const backdrop = document.getElementById("mobile-sidebar-backdrop");
            if (sidebar.classList.contains("-translate-x-full")) {
                sidebar.classList.remove("-translate-x-full");
                backdrop.classList.remove("hidden");
                setTimeout(() => backdrop.classList.add("opacity-100"), 10);
            } else {
                sidebar.classList.add("-translate-x-full");
                backdrop.classList.remove("opacity-100");
                setTimeout(() => backdrop.classList.add("hidden"), 300);
            }
        };
        window.goHome = () => location.hash = "";

        function handleRoute() {
            const hash = location.hash;
            document.querySelectorAll('[id$="-view"]').forEach(el => el.classList.add("hidden"));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove("active"));
            document.getElementById("sidebar").classList.add("-translate-x-full");
            document.getElementById("mobile-sidebar-backdrop").classList.add("hidden");
            document.getElementById("mobile-sidebar-backdrop").classList.remove("opacity-100");

            if (hash.startsWith("#detail/")) {
                const id = hash.split("/")[1];
                showDetailView(id);
            } else if (hash.startsWith("#board/")) {
                const type = hash.split("/")[1];
                showBoardView(type);
                const link = document.querySelector(`a[onclick*="#board/${type}"]`);
                if(link) link.classList.add("active");
            } else if (hash === "#freeboard") {
                document.getElementById("free-board-view").classList.remove("hidden");
                const link = document.querySelector(`a[onclick*="#freeboard"]`);
                if(link) link.classList.add("active");
                loadFreeBoard();
            } else {
                document.getElementById("home-view").classList.remove("hidden");
                const link = document.querySelector(`a[onclick*="''"]`);
                if(link) link.classList.add("active");
                window.scrollTo(0,0);
            }
        }
        window.addEventListener('hashchange', handleRoute);
        window.addEventListener('load', handleRoute);

        function showBoardView(type) {
            const titles = { notice: "ê³µì§€ì‚¬í•­", tip: "ëŒ€ì „ ì—¬í–‰ ê¿€íŒ", event: "ì¶•ì œ & ì´ë²¤íŠ¸" };
            const descs = { notice: "ìƒˆë¡œìš´ ì†Œì‹ì„ í™•ì¸í•˜ì„¸ìš”.", tip: "í˜„ì§€ì¸ì´ ì•Œë ¤ì£¼ëŠ” ì§„ì§œ ì •ë³´!", event: "ë‹¤ì±„ë¡œìš´ ì¦ê±°ì›€ì´ ê°€ë“!" };
            document.getElementById("board-title").innerText = titles[type];
            document.getElementById("board-desc").innerText = descs[type];
            document.getElementById("board-view").classList.remove("hidden");
            window.scrollTo(0,0);
            
            const btn = document.getElementById("board-write-btn");
            if(isAdmin) btn.classList.remove("hidden"); else btn.classList.add("hidden");
            loadBoardData(type);
        }

        function loadBoardData(type) {
            if(!db) return;
            const list = document.getElementById("board-list");
            list.innerHTML = '<div class="text-center py-20 text-gray-400">ë¡œë”© ì¤‘...</div>';
            
            let filtered;
            if (type === 'event') {
                filtered = allNotices.filter(n => n.category === 'event' || n.category === 'festival');
            } else {
                filtered = allNotices.filter(n => n.category === type);
            }
            filtered.sort((a,b) => b.createdAt - a.createdAt);
            
            list.innerHTML = "";
            if(filtered.length > 0) {
                filtered.forEach(n => {
                    const date = new Date(n.createdAt).toLocaleDateString();
                    const safeTitle = (n.title || n.text.substring(0, 20)).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const icon = n.category === 'notice' ? 'megaphone' : (n.category === 'tip' ? 'lightbulb' : 'calendar');
                    let badge = "";
                    if (n.category === 'festival') badge = `<span class="bg-purple-100 text-purple-700 text-[10px] px-1.5 py-0.5 rounded ml-1 font-bold align-middle">ğŸ† ì¶•ì œ</span>`;
                    else if (n.category === 'event') badge = `<span class="bg-orange-100 text-orange-700 text-[10px] px-1.5 py-0.5 rounded ml-1 font-bold align-middle">ğŸ ì´ë²¤íŠ¸</span>`;
                    else if (n.category === 'notice') badge = `<span class="bg-red-100 text-red-700 text-[10px] px-1.5 py-0.5 rounded ml-1 font-bold align-middle">ğŸ“¢ ê³µì§€</span>`;
                    else if (n.category === 'tip') badge = `<span class="bg-yellow-100 text-yellow-700 text-[10px] px-1.5 py-0.5 rounded ml-1 font-bold align-middle">ğŸ¯ ê¿€íŒ</span>`;

                    list.innerHTML += `<div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow cursor-pointer" onclick="openNoticeDetail('${n.id}')"><div class="flex justify-between items-start mb-2"><h3 class="font-bold text-gray-800 text-lg flex items-center"><i data-lucide="${icon}" class="w-4 h-4 mr-2 text-emerald-600"></i> ${safeTitle}${badge}</h3><span class="text-xs text-gray-400 shrink-0">${date}</span></div><p class="text-gray-500 text-sm line-clamp-1">${n.text.replace(/<[^>]*>/g, '')}</p></div>`;
                });
                lucide.createIcons();
            } else { list.innerHTML = '<div class="text-center py-20 text-gray-400">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; }
        }

        function showDetailView(id) {
            try {
                if (allPlaces.length === 0) { setTimeout(() => showDetailView(id), 500); return; }
                const place = allPlaces.find(p => p.id === id);
                if(!place) { alert("í•´ë‹¹ ì—¬í–‰ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); location.hash=""; return; }
                
                if (db && !sessionStorage.getItem(`viewed_${id}`)) {
                    updateDoc(doc(db, "places", id), { views: increment(1) }).catch(e=>{});
                    sessionStorage.setItem(`viewed_${id}`, "true");
                    place.views = (place.views || 0) + 1;
                }

                currentDetailImages = (place.images && place.images.length > 0) ? place.images : [place.image || 'https://via.placeholder.com/800?text=No+Image'];
                currentImgIdx = 0;
                const imgLoader = document.getElementById("detail-img-loader");
                const imgEl = document.getElementById("detail-img");
                imgEl.onload = () => { imgLoader.classList.add("hidden"); imgEl.classList.remove("opacity-0"); };
                
                window.updateCarousel = () => {
                    imgLoader.classList.remove("hidden"); imgEl.classList.add("opacity-0");
                    const prev = document.getElementById("btn-prev");
                    const next = document.getElementById("btn-next");
                    const indic = document.getElementById("img-indicator");
                    imgEl.src = currentDetailImages[currentImgIdx];
                    indic.innerText = `${currentImgIdx + 1} / ${currentDetailImages.length}`;
                    if(currentDetailImages.length > 1) { indic.classList.remove("hidden"); if(currentImgIdx === 0) prev.classList.add("hidden"); else prev.classList.remove("hidden"); if(currentImgIdx === currentDetailImages.length - 1) next.classList.add("hidden"); else next.classList.remove("hidden"); } else { indic.classList.add("hidden"); prev.classList.add("hidden"); next.classList.add("hidden"); }
                };
                updateCarousel();

                document.getElementById("detail-title").innerText = place.name;
                document.getElementById("detail-desc").innerText = place.description;
                document.getElementById("detail-district").innerText = place.district;
                document.getElementById("detail-rating").innerText = place.rating || 0;
                document.getElementById("detail-views").innerText = place.views || 0;
                document.getElementById("detail-tags").innerHTML = (place.tags || []).map(t => `<span class="bg-gray-100 text-gray-600 px-3 py-1.5 rounded-lg text-sm font-medium">#${t}</span>`).join('');

                document.getElementById("detail-view").classList.remove("hidden");
                window.scrollTo(0, 0);
                if(window.lucide) lucide.createIcons();
            } catch(e) { location.hash = ""; }
        }

        let currentDetailImages = [];
        let currentImgIdx = 0;
        window.updateCarousel = () => {};
        window.nextImage = () => { if(currentImgIdx < currentDetailImages.length-1) { currentImgIdx++; updateCarousel(); }};
        window.prevImage = () => { if(currentImgIdx > 0) { currentImgIdx--; updateCarousel(); }};

        window.filterDistrict = (d) => { currentFilter = d; updateFilterUI(); renderPlaces(); };
        window.sortPlaces = (s) => { currentSort = s; renderPlaces(); };
        function updateFilterUI() { document.querySelectorAll(".cat-btn").forEach(btn => { if(btn.dataset.val === currentFilter) btn.className = "cat-btn active px-3 py-1.5 rounded-lg text-sm font-bold bg-emerald-100 text-emerald-700 transition-colors whitespace-nowrap"; else btn.className = "cat-btn px-3 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-50 transition-colors whitespace-nowrap"; }); }

        window.renderPlaces = () => {
            const grid = document.getElementById("places-grid");
            grid.innerHTML = "";
            let filtered = currentFilter === "ì „ì²´" ? allPlaces : allPlaces.filter(p => p.district === currentFilter);
            filtered.sort((a, b) => { if(currentSort === 'rating') return (b.rating||0) - (a.rating||0); if(currentSort === 'views') return (b.views||0) - (a.views||0); return (b.createdAt||0) - (a.createdAt||0); });
            filtered.forEach(place => {
                const thumb = (place.images && place.images.length > 0) ? place.images[0] : (place.image || 'https://via.placeholder.com/400?text=No+Image');
                const card = document.createElement("div");
                card.className = "group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all border border-gray-100 overflow-hidden flex flex-col h-full cursor-pointer relative";
                card.onclick = (e) => { if(e.target.closest('.admin-btn')) return; location.hash = "#detail/" + place.id; };
                let adminHtml = isAdmin ? `<div class="absolute top-2 right-2 z-20 flex gap-1"><button onclick="event.stopPropagation(); editPlace('${place.id}')" class="admin-btn bg-white/90 p-2 rounded-full text-blue-600 hover:bg-blue-100 shadow-sm"><i data-lucide="edit-2" class="w-3 h-3"></i></button><button onclick="event.stopPropagation(); deletePlace('${place.id}')" class="admin-btn bg-white/90 p-2 rounded-full text-red-600 hover:bg-red-100 shadow-sm"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>` : "";
                card.innerHTML = `<div class="relative h-48 overflow-hidden bg-gray-100"><img src="${thumb}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"><div class="absolute top-3 left-3 bg-white/90 backdrop-blur px-2 py-1 rounded-md text-[10px] font-bold text-emerald-600 shadow-sm z-10">${place.district}</div>${adminHtml}</div><div class="p-5 flex flex-col flex-1"><div class="flex justify-between items-start mb-2"><h3 class="text-lg font-bold text-gray-800 group-hover:text-emerald-600 transition-colors line-clamp-1">${place.name}</h3><div class="flex items-center text-yellow-500 text-xs font-bold bg-yellow-50 px-1.5 py-0.5 rounded ml-2 shrink-0"><i data-lucide="star" class="w-3 h-3 fill-yellow-500 mr-1"></i> ${place.rating || 0}</div></div><p class="text-gray-500 text-sm mb-4 line-clamp-2 leading-relaxed">${place.description}</p><div class="mt-auto flex items-center justify-between"><div class="flex gap-1 flex-wrap">${(place.tags || []).slice(0, 3).map(t => `<span class="bg-gray-100 text-gray-500 text-[10px] px-2 py-1 rounded-md">#${t}</span>`).join('')}</div><div class="text-gray-400 text-xs flex items-center"><i data-lucide="eye" class="w-3 h-3 mr-1"></i> ${place.views || 0}</div></div></div>`;
                grid.appendChild(card);
            });
            lucide.createIcons();
        };

        if (db) {
            onSnapshot(collection(db, "places"), (snapshot) => { allPlaces = []; snapshot.forEach(doc => allPlaces.push({ id: doc.id, ...doc.data() })); document.getElementById("loader-area").classList.add("hidden"); document.getElementById("places-grid").classList.remove("hidden"); renderPlaces(); if(location.hash.startsWith("#detail/")) handleRoute(); });
            onSnapshot(collection(db, "notices"), (snapshot) => { allNotices = []; snapshot.forEach(doc => allNotices.push({ id: doc.id, ...doc.data() })); if(location.hash.startsWith("#board/")) loadBoardData(location.hash.split("/")[1]); });
            onSnapshot(doc(db, "config", "hero"), (doc) => { if(doc.exists()) { const d=doc.data(); if(d.title) document.getElementById("hero-main-text").innerHTML=d.title; if(d.subtitle) document.getElementById("hero-sub-text").innerText=d.subtitle; if(d.image) document.getElementById("hero-bg-img").src=d.image; }});
            const offset = 1000 * 60 * 60 * 9; const todayKey = new Date(Date.now() + offset).toISOString().split('T')[0];
            onSnapshot(doc(db, "stats", "global"), (doc) => { if(doc.exists()) { document.getElementById("total-count").innerText = (doc.data().total||0).toLocaleString(); document.getElementById("daily-count").innerText = (doc.data()[todayKey]||0).toLocaleString(); }});
            if(!sessionStorage.getItem("visited")) { setDoc(doc(db, "stats", "global"), { total: increment(1), [todayKey]: increment(1) }, { merge: true }); sessionStorage.setItem("visited", "true"); }
        }

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                const isPasswordAuth = user && user.providerData.some(p => p.providerId === 'password');
                isAdmin = isPasswordAuth || (user && user.email === 'admin@test.com');
                const authBtn = document.getElementById("auth-btn");
                const profileImg = document.getElementById("user-profile-img");
                if(user) { authBtn.innerHTML = `<i data-lucide="log-out" class="w-3.5 h-3.5 mr-1"></i> ë¡œê·¸ì•„ì›ƒ`; authBtn.onclick = async () => { if(confirm("ë¡œê·¸ì•„ì›ƒ?")) await signOut(auth); }; if(user.photoURL) { profileImg.src = user.photoURL; profileImg.classList.remove("hidden"); } else { profileImg.classList.add("hidden"); } updateAdminUI(); } 
                else { authBtn.innerHTML = `<i data-lucide="log-in" class="w-3.5 h-3.5 mr-1"></i> ë¡œê·¸ì¸`; authBtn.onclick = openLoginModal; profileImg.classList.add("hidden"); isAdmin = false; updateAdminUI(); }
                renderPlaces(); if(location.hash === "#freeboard") loadFreeBoard();
            });
        }

        function updateAdminUI() { const els = ['write-btn', 'board-write-btn', 'edit-hero-btn']; els.forEach(id => { const el = document.getElementById(id); if(el) { if(isAdmin) el.classList.remove("hidden"); else el.classList.add("hidden"); }}); }

        window.openLoginModal = () => document.getElementById("login-modal").classList.remove("hidden");
        window.closeModal = (id) => document.getElementById(id).classList.add("hidden");
        window.handleAdminLogin = async() => { try { await signInWithEmailAndPassword(auth, document.getElementById("email").value, document.getElementById("password").value); closeModal("login-modal"); } catch(e) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message); }};
        window.loginWithGoogle = async () => { try { const provider = new GoogleAuthProvider(); await signInWithPopup(auth, provider); closeModal("login-modal"); } catch (error) { alert("êµ¬ê¸€ ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message); }};

        window.openNoticeDetail = (id) => {
            let n = allNotices.find(item => item.id === id);
            if (!n) { getDoc(doc(db, "notices", id)).then(snap => { if(snap.exists()) { n = {id: snap.id, ...snap.data()}; renderNoticeDetail(n); } else { alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê¸€"); }}); } else { renderNoticeDetail(n); }
        };
        function renderNoticeDetail(n) {
            const titles = { notice: "ê³µì§€ì‚¬í•­", tip: "ê¿€íŒ", event: "ì´ë²¤íŠ¸", festival: "ì¶•ì œ" };
            document.getElementById("notice-detail-cat").innerText = titles[n.category] || "ì•Œë¦¼";
            document.getElementById("notice-detail-title").innerText = n.title || "";
            document.getElementById("notice-detail-content").innerHTML = n.text; 
            document.getElementById("notice-detail-date").innerText = new Date(n.createdAt).toLocaleDateString();
            const btns = document.getElementById("notice-admin-btns");
            if(isAdmin) { btns.classList.remove("hidden"); btns.classList.add("flex"); document.getElementById("btn-notice-edit").onclick = () => { closeModal('notice-detail-modal'); editNotice(n.id); }; document.getElementById("btn-notice-delete").onclick = () => { deleteNotice(n.id); }; } else { btns.classList.add("hidden"); }
            document.getElementById("notice-detail-modal").classList.remove("hidden");
        }
        window.editNotice = (id) => { getDoc(doc(db, "notices", id)).then(snap => { if(snap.exists()) { const n = snap.data(); openNoticeModal(); document.getElementById("notice-modal-title").innerText = "ê²Œì‹œê¸€ ìˆ˜ì •"; document.getElementById("notice-edit-id").value = id; document.getElementById("notice-cat").value = n.category; document.getElementById("notice-title").value = n.title || ""; document.getElementById("notice-text").value = n.text; document.getElementById("notice-save-btn").innerText = "ìˆ˜ì •í•˜ê¸°"; }}); };
        window.deleteNotice = async (id) => { if(confirm("ì‚­ì œ?")) { await deleteDoc(doc(db, "notices", id)); closeModal("notice-detail-modal"); alert("ì‚­ì œë¨"); }};
        window.openNoticeModal = () => { document.getElementById("notice-modal-title").innerText="ê²Œì‹œê¸€ ë“±ë¡"; document.getElementById("notice-edit-id").value=""; document.getElementById("notice-title").value=""; document.getElementById("notice-text").value=""; document.getElementById("notice-save-btn").innerText="ë“±ë¡"; document.getElementById("notice-modal").classList.remove("hidden"); };
        window.saveNotice = async() => {
            const id = document.getElementById("notice-edit-id").value; const cat = document.getElementById("notice-cat").value; const title = document.getElementById("notice-title").value; const t = document.getElementById("notice-text").value;
            if(!title || !t) return alert("ì…ë ¥ í•„ìš”");
            try { if(id) await updateDoc(doc(db, "notices", id), {category:cat, title, text:t}); else await addDoc(collection(db, "notices"), {category:cat, title, text:t, createdAt:Date.now()}); closeModal("notice-modal"); if (location.hash.startsWith(`#board/`)) loadBoardData(location.hash.split("/")[1]); } catch(e) { alert("ì‹¤íŒ¨"); }
        };

        window.loadFreeBoard = () => {
            if(!db) return;
            const list = document.getElementById("free-board-list");
            list.innerHTML = '<div class="text-center py-20 text-gray-400">ë¡œë”©...</div>';
            const q = query(collection(db, "free_posts"), orderBy("createdAt", freeBoardSort));
            onSnapshot(q, (snap) => {
                list.innerHTML = "";
                snap.forEach(doc => {
                    const p = doc.data();
                    const date = new Date(p.createdAt).toLocaleDateString();
                    const avatar = p.photo || 'https://via.placeholder.com/40?text=U';
                    const badge = (p.isAdmin) ? `<span class="bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded-md font-bold ml-1 align-middle">ê´€ë¦¬ì</span>` : "";
                    list.innerHTML += `<div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow cursor-pointer" onclick="openFreeDetail('${doc.id}', '${p.uid}')"><div class="flex items-center gap-3 mb-2"><img src="${avatar}" class="w-8 h-8 rounded-full border border-gray-100"><div><div class="text-xs text-gray-500 flex items-center">${p.author} ${badge}</div><h3 class="font-bold text-gray-800 text-base line-clamp-1">${p.title}</h3></div><span class="text-xs text-gray-400 ml-auto">${date}</span></div><p class="text-gray-500 text-sm line-clamp-2 pl-11">${p.text}</p></div>`;
                });
                if(snap.empty) list.innerHTML = '<div class="text-center py-20 text-gray-400">ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            });
        };
        window.openFreeDetail = async (id, uid) => {
            currentFreePostId = id;
            const docSnap = await getDoc(doc(db, "free_posts", id));
            if(!docSnap.exists()) return alert("ì‚­ì œëœ ê¸€");
            const p = docSnap.data();
            const badge = (p.isAdmin) ? `<span class="bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded-md font-bold ml-1 align-middle">ê´€ë¦¬ì</span>` : "";
            document.getElementById("free-detail-title").innerText = p.title;
            document.getElementById("free-detail-content").innerText = p.text;
            document.getElementById("free-detail-author").innerHTML = p.author + badge;
            document.getElementById("free-detail-date").innerText = new Date(p.createdAt).toLocaleDateString();
            document.getElementById("free-detail-avatar").src = p.photo || 'https://via.placeholder.com/40?text=U';
            
            const btnBox = document.getElementById("free-owner-btns");
            if (isAdmin || (currentUser && currentUser.uid === uid)) { btnBox.classList.remove("hidden"); btnBox.classList.add("flex"); document.getElementById("btn-free-delete").onclick = async () => { if(confirm("ì‚­ì œ?")) { await deleteDoc(doc(db, "free_posts", id)); closeModal("free-detail-modal"); } }; } else btnBox.classList.add("hidden");
            loadComments(id); document.getElementById("free-detail-modal").classList.remove("hidden");
        };
        window.openFreeWriteModal = () => { if(!currentUser) { alert("ë¡œê·¸ì¸ í•„ìš”"); openLoginModal(); return; } document.getElementById("free-title").value=""; document.getElementById("free-text").value=""; document.getElementById("free-write-modal").classList.remove("hidden"); };
        window.saveFreePost = async () => {
            const title = document.getElementById("free-title").value; const text = document.getElementById("free-text").value;
            if(!title || !text) return alert("ì…ë ¥ í•„ìš”");
            await addDoc(collection(db, "free_posts"), {title, text, author:currentUser.displayName||"ìµëª…", uid:currentUser.uid, photo:currentUser.photoURL, createdAt:Date.now(), isAdmin: isAdmin});
            closeModal("free-write-modal"); alert("ë“±ë¡ë¨");
        };
        window.sortFreeBoard = (m) => { freeBoardSort = m; loadFreeBoard(); };

        let commentUnsub;
        function loadComments(postId) {
            if(commentUnsub) commentUnsub();
            const list = document.getElementById("comment-list");
            list.innerHTML = "<div class='text-xs text-gray-400 text-center'>ë¡œë”©...</div>";
            const q = query(collection(db, "comments"), where("postId", "==", postId));
            commentUnsub = onSnapshot(q, (snap) => {
                const comments = [];
                snap.forEach(doc => comments.push({id: doc.id, ...doc.data()}));
                comments.sort((a,b) => a.createdAt - b.createdAt);
                document.getElementById("comment-count").innerText = comments.length;
                list.innerHTML = "";
                if(comments.length === 0) { list.innerHTML="<div class='text-center text-xs text-gray-400 py-2'>ëŒ“ê¸€ ì—†ìŒ</div>"; return; }
                comments.forEach(c => {
                    const date = new Date(c.createdAt).toLocaleDateString();
                    const isOwner = isAdmin || (currentUser && currentUser.uid === c.uid);
                    const delBtn = isOwner ? `<button onclick="deleteComment('${c.id}')" class="text-[10px] text-red-400 ml-2">ì‚­ì œ</button>` : "";
                    const badge = (c.isAdmin) ? `<span class="bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded-md font-bold ml-1 align-middle">ê´€ë¦¬ì</span>` : "";
                    list.innerHTML += `<div class="bg-white p-2.5 rounded-lg border border-gray-100 shadow-sm text-sm"><div class="flex justify-between items-start mb-1"><div class="flex items-center gap-1.5"><span class="font-bold text-gray-700 text-xs">${c.author} ${badge}</span><span class="text-[10px] text-gray-400">${date}</span></div>${delBtn}</div><div class="text-gray-600 text-sm break-all">${c.text}</div></div>`;
                });
            });
        }
        window.saveComment = async (e) => {
            e.preventDefault(); if(!currentUser) return alert("ë¡œê·¸ì¸ í•„ìš”");
            const inp = document.getElementById("comment-input");
            if(inp.value.trim()) { await addDoc(collection(db, "comments"), {postId:currentFreePostId, text:inp.value, author:currentUser.displayName||"ìµëª…", uid:currentUser.uid, createdAt:Date.now(), isAdmin: isAdmin}); inp.value=""; }
        };
        window.deleteComment = async (id) => { if(confirm("ì‚­ì œ?")) await deleteDoc(doc(db, "comments", id)); };

        let upImgs = [];
        window.openWriteModal = () => { upImgs=[]; document.getElementById("preview-area").innerHTML=""; document.getElementById("write-modal").classList.remove("hidden"); };
        document.getElementById("inp-files").addEventListener("change", async(e) => {
            const files = Array.from(e.target.files);
            if(!files.length) return;
            document.getElementById("upload-status").classList.remove("hidden");
            try { const urls = await Promise.all(files.map(f => uploadBytesResumable(ref(storage, 'img/'+Date.now()+'_'+f.name), f).then(s => getDownloadURL(s.ref)))); upImgs=[...upImgs,...urls]; const p=document.getElementById("preview-area"); urls.forEach(u=>p.innerHTML+=`<img src="${u}" class="h-16 w-16 object-cover rounded-lg border">`); document.getElementById("upload-status").innerText="ì™„ë£Œ"; } catch(e){alert("ì—…ë¡œë“œ ì‹¤íŒ¨");}
        });
        window.savePlace = async() => {
            const id = document.getElementById("edit-id").value;
            const data = { name: document.getElementById("inp-name").value, district: document.getElementById("inp-district").value, rating: parseFloat(document.getElementById("inp-rating").value)||0, description: document.getElementById("inp-desc").value, tags: document.getElementById("inp-tags").value.split(",").filter(t=>t.trim()), images: upImgs, image: upImgs[0]||"", createdAt: Date.now() };
            if(!data.name) return alert("ì œëª© í•„ìš”");
            try { if(id) await updateDoc(doc(db, "places", id), data); else { data.views=0; await addDoc(collection(db, "places"), data); } closeModal("write-modal"); } catch(e){alert("ì‹¤íŒ¨");}
        };
        window.editPlace = (id) => {
            const p = allPlaces.find(x=>x.id===id); if(!p) return;
            openWriteModal(); document.getElementById("write-modal-title").innerText="ì—¬í–‰ì§€ ìˆ˜ì •"; document.getElementById("edit-id").value=p.id; document.getElementById("inp-name").value=p.name; document.getElementById("inp-district").value=p.district; document.getElementById("inp-rating").value=p.rating; document.getElementById("inp-desc").value=p.description; document.getElementById("inp-tags").value=p.tags.join(","); upImgs=p.images||[p.image];
            const pr = document.getElementById("preview-area"); upImgs.forEach(u=>{if(u) pr.innerHTML+=`<img src="${u}" class="h-16 w-16 object-cover rounded-lg border">`;});
        };
        window.deletePlace = async(id) => { if(confirm("ì‚­ì œ?") && db) await deleteDoc(doc(db, "places", id)); };
        
        window.openHeroEditModal = () => document.getElementById("hero-edit-modal").classList.remove("hidden");
        window.saveHeroConfig = async () => { try { await setDoc(doc(db, "config", "hero"), {title:document.getElementById("edit-hero-title").value, subtitle:document.getElementById("edit-hero-sub").value, image:document.getElementById("edit-hero-img").value}, {merge:true}); closeModal("hero-edit-modal"); alert("ì ìš©ë¨"); } catch(e){alert("ì‹¤íŒ¨");}};

        // Chat
        let chatInit = false;
        function initChatListener() {
            if (!db || chatInit) return;
            chatInit = true;
            const q = query(collection(db, "chat"), orderBy("createdAt", "asc"), limit(50));
            onSnapshot(q, (snap) => {
                const boxes = [document.getElementById("desktop-chat-messages"), document.getElementById("mobile-chat-messages")];
                const html = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    const isAdm = d.uid && (d.uid === 'admin' || d.uid === 'SENDER_ID' || (isAdmin && d.uid === currentUser?.uid));
                    const delBtn = isAdmin ? `<button onclick="deleteChat('${doc.id}')" class="ml-2 text-xs text-red-300 hover:text-red-500">Ã—</button>` : "";
                    html.push(`<div class="flex flex-col ${isAdm?'items-start':'items-end'}"><div class="${isAdm?'bg-emerald-100 text-emerald-900':'bg-gray-100 text-gray-800'} px-3 py-1.5 rounded-lg text-sm max-w-[85%] flex items-center">${d.text}${delBtn}</div></div>`);
                });
                boxes.forEach(b => { if(b) { b.innerHTML = html.join(''); b.scrollTop = b.scrollHeight; }});
            });
        }
        initChatListener();
        window.toggleMobileChat = () => { document.getElementById("mobile-chat-window").classList.toggle("hidden"); };
        window.sendChat = async(e, mode) => {
            e.preventDefault(); const inp = document.getElementById(mode === 'desktop' ? "desktop-chat-input" : "mobile-chat-input");
            if(inp.value.trim() && db) { await addDoc(collection(db, "chat"), { text: inp.value, createdAt: Date.now(), uid: currentUser?currentUser.uid:'anon', author: currentUser?currentUser.displayName:'ìµëª…' }); inp.value=""; }
        };
        window.deleteChat = async (id) => { if(confirm("ì‚­ì œ?")) await deleteDoc(doc(db, "chat", id)); };

        window.lucide = lucide;
    </script>
</body>
</html>
